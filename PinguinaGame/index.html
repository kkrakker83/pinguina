<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Llipsia la Pingüina</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    body { margin: 0; overflow: hidden; }
    canvas {
      background: #87ceeb;
      display: block;
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      touch-action: none;
      -webkit-user-select: none;
      user-select: none;
    }
    #info {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      color: #fff;
      font-family: sans-serif;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="info">Cargando...</div>
  <canvas id="gameCanvas" width="800" height="400"></canvas>
  <script>
    // --- Setup ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const W = canvas.width, H = canvas.height;

    // Personaje
    const llipsia = { x: 50, y: H/2, w: 40, h: 50, dy: 0, gravity: 0.5, jumpForce: -8 };

    // Obstáculos
    let obstáculos = [];
    const spawnInterval = 1500;
    const obstVel = 4;
    let últimoSpawn = 0;

    // Estado
    let gameOver = false, score = 0;

    // Assets
    const assets = {
      llipsia: { img: new Image(), ok: false },
      obst:    { img: new Image(), ok: false },
      obstTop: { img: new Image(), ok: false }
    };
    let loadedCount = 0;
    function markLoaded(key) {
      return function() {
        assets[key].ok = true;
        loadedCount++;
        if (loadedCount === 3) {
          document.getElementById('info').textContent = 'Toca o haz clic para volar';
          resetGame();
        }
      };
    }
    assets.llipsia.img.onload = assets.llipsia.img.onerror = markLoaded('llipsia');
    assets.llipsia.img.src = 'assets/llipsia.png';
    assets.obst.img.onload    = assets.obst.img.onerror    = markLoaded('obst');
    assets.obst.img.src        = 'assets/obstaculo.png';
    assets.obstTop.img.onload = assets.obstTop.img.onerror = markLoaded('obstTop');
    assets.obstTop.img.src    = 'assets/obstaculo1.png';

    // Input: volar con toque o clic
    function fly() {
      if (!gameOver) llipsia.dy = llipsia.jumpForce;
      else resetGame();
    }
    ['touchstart','mousedown','pointerdown'].forEach(evt => {
      canvas.addEventListener(evt, e => { e.preventDefault(); fly(); }, { passive: false });
    });
    document.addEventListener('keydown', e => {
      if (e.code === 'Space') fly();
    });

    // Reset
    function resetGame() {
      obstáculos = [];
      llipsia.y = H/2;
      llipsia.dy = 0;
      últimoSpawn = performance.now() - spawnInterval;
      score = 0;
      gameOver = false;
      requestAnimationFrame(loop);
    }

    // Loop
    function loop(ts) {
      if (gameOver) return drawGameOver();
      // Física
      llipsia.dy += llipsia.gravity;
      llipsia.y += llipsia.dy;
      if (llipsia.y + llipsia.h > H) { llipsia.y = H - llipsia.h; gameOver = true; }
      if (llipsia.y < 0) { llipsia.y = 0; llipsia.dy = 0; }
      // Spawn
      if (ts - últimoSpawn >= spawnInterval) {
        const w = 30 + Math.random()*30;
        const h = 30 + Math.random()*30;
        obstáculos.push({ x: W, y: H-h, w, h, roof: false });
        obstáculos.push({ x: W, y: 0,    w, h, roof: true  });
        últimoSpawn = ts;
      }
      // Obstáculos
      obstáculos.forEach((o, i) => {
        o.x -= obstVel;
        // Colisión
        if (llipsia.x < o.x + o.w && llipsia.x + llipsia.w > o.x && llipsia.y < o.y + o.h && llipsia.y + llipsia.h > o.y) gameOver = true;
        if (o.x + o.w < 0) { obstáculos.splice(i,1); if (!gameOver) score++; }
      });
      // Dibujar
      ctx.clearRect(0,0,W,H);
      drawBackground(); drawLlipsia(); drawObstacles(); drawScore();
      requestAnimationFrame(loop);
    }

    // Dibujos
    function drawBackground() {
      ctx.save(); ctx.globalAlpha=0.1; ctx.fillStyle='#fff'; ctx.font='100px sans-serif'; ctx.textAlign='center';
      ctx.fillText('Llipsia', W/2, H/2); ctx.restore();
    }
    function drawLlipsia() {
      if (assets.llipsia.ok && assets.llipsia.img.naturalWidth) ctx.drawImage(assets.llipsia.img, llipsia.x, llipsia.y, llipsia.w, llipsia.h);
      else { ctx.fillStyle='#000'; ctx.fillRect(llipsia.x, llipsia.y, llipsia.w, llipsia.h); }
    }
    function drawObstacles() {
      obstáculos.forEach(o => {
        ctx.fillStyle = '#c33'; ctx.fillRect(o.x,o.y,o.w,o.h);
        const spr = o.roof ? assets.obstTop : assets.obst;
        if (spr.ok && spr.img.naturalWidth) ctx.drawImage(spr.img, o.x,o.y,o.w,o.h);
      });
    }
    function drawScore() {
      ctx.fillStyle='#fff'; ctx.font='20px sans-serif'; ctx.fillText('Score: '+score,10,25);
    }
    function drawGameOver() {
      ctx.fillStyle='rgba(0,0,0,0.5)'; ctx.fillRect(0,0,W,H);
      ctx.fillStyle='#fff'; ctx.font='40px sans-serif'; ctx.textAlign='center'; ctx.fillText('¡Game Over!',W/2,H/2-20);
      ctx.font='20px sans-serif'; ctx.fillText('Toca o haz clic para reiniciar',W/2,H/2+10);
    }
  </script>
</body>
</html>